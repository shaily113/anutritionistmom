<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Profile | A Nutritionist Mom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --accent:#8b5e3c;
      --bg:#faf4ef;
      --text:#3b2f27;
    }

    body{
      margin:0;
      font-family:"Poppins",sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ================= MENU ICON ================= */
    .menu-icon{
      position:fixed;
      top:20px;
      left:20px;
      font-size:28px;
      cursor:pointer;
      z-index:1000;
      background:#fff;
      padding:6px 12px;
      border-radius:8px;
      border:none;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }

    
    /* ================= SIDEBAR ================= */
    #sidebar{
      position:fixed;
      left:-260px;
      top:0;
      width:260px;
      height:100%;
      background:#fff;
      box-shadow:2px 0 10px rgba(0,0,0,0.1);
      transition:left 0.28s ease;
      z-index:999;
      padding-top:80px;
    }
    #sidebar.active{ left:0; }

    #sidebar ul{
      list-style:none;
      padding:0;
      margin:0;
    }

    #sidebar ul li{
      padding:12px 22px;
    }

    #sidebar ul li a{
      text-decoration:none;
      color:#4a3c2b;
      font-weight:500;
      display:block;
    }

    #sidebar ul li a:hover{
      color:var(--accent);
    }

    .navbar-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.3);
      display:none;
      z-index:998;
    }
    .navbar-overlay.show{ display:block; }

    /* ===== SIDEBAR DIVIDER ===== */
    .sidebar-divider{
      height:1px;
      background:#e2d6cc;
      margin:14px 18px;
      padding:0 !important;
    }

    /* ===== SIDEBAR ACTION BUTTONS ===== */
    .sidebar-actions{
      display:flex;
      gap:10px;
      padding:10px 18px;
    }

    .sidebar-btn{
      flex:1;
      background:#8b5e3c;
      color:#fff;
      border:none;
      padding:8px 0;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }

    .sidebar-btn:hover{ background:#70492f; }

    .sidebar-btn.logout{
      background:#70492f;
    }
    /* ===== PAGE ===== */
    .page{
      margin-left:250px;
      padding:110px 32px 40px;
      max-width:700px;
    }

    h1{
      color:var(--accent);
      margin-bottom:20px;
    }

    .profile-card{
      background:#fff;
      padding:26px;
      border-radius:14px;
      box-shadow:0 6px 20px rgba(0,0,0,0.08);
    }

    .profile-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:18px 22px;
    }

    .field{
      display:flex;
      flex-direction:column;
    }

    .field label{
      font-size:14px;
      font-weight:600;
      margin-bottom:6px;
    }

    .field input{
      padding:11px 12px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:15px;
      background:#f2f2f2;
    }

    .actions{
      margin-top:24px;
      display:flex;
      justify-content:flex-end;
    }

    .actions button{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:10px 22px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
    }

    @media(max-width:900px){
      .page{ margin-left:0; padding:100px 20px; }
      .profile-grid{ grid-template-columns:1fr; }
    }
  /* ===========================
   FIXED TOP BAR
   =========================== */

.top-bar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 64px;
  background: #fffaf5;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  z-index: 1000;
}

.top-bar-inner {
  max-width: 1200px;
  height: 100%;
  margin: 0 auto;
  padding: 0 85px;
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Brand name */
.brand-name {
  font-size: 18px;
  font-weight: 600;
  color: #8b5e3c;
  letter-spacing: 0.3px;
}
  </style>
</head>

<body>
 <!-- FIXED TOP BAR -->
<header class="top-bar">
  <div class="top-bar-inner">
    <span class="brand-name"><strong>A Nutritionist Mom</strong></span>
  </div>
</header>
<!-- MENU ICON -->
<button class="menu-icon" id="menu-icon">☰</button>

<!-- OVERLAY -->
<div id="navbar-overlay" class="navbar-overlay"></div>

<!-- SIDEBAR -->
<nav id="sidebar">
  <ul>
    <li><a href="dashboard.html">Dashboard</a></li>
    <li><a href="zpren.html">Prenatal</a></li>
    <li><a href="zpost.html">Postpartum</a></li>
    <li><a href="zprec.html">Preconception</a></li>
   
    <li><a href="z1-1.html">1–1 Consultation</a></li>
 

    <li class="sidebar-divider"></li>

    <li class="sidebar-actions" id="sidebar-actions" style="display:none;">
      <button class="sidebar-btn" id="sidebar-profile">Profile</button>

      <button class="sidebar-btn logout" id="sidebar-logout">Logout</button>
    </li>
  </ul>
</nav>

<!-- ===== PROFILE VIEW ===== -->
<div class="page">
  <h1>My Profile</h1>

  <div class="profile-card">
    <div class="profile-grid">

      <div class="field">
        <label>Email</label>
        <input id="email" readonly>
      </div>

      <div class="field">
        <label>Full Name</label>
        <input id="full_name" readonly>
      </div>

      <div class="field">
        <label>Age</label>
        <input id="age" readonly>
      </div>

      <div class="field">
        <label>Mobile</label>
        <input id="mobile" readonly>
      </div>
<div class="field">
  <label>Concern</label>
  <input id="concern" readonly>
</div>


    </div>

    
  </div>
</div>

<!-- ===== SUPABASE + JS ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;

const supabaseClient = createClient(
   "https://kajqxzywlanjmjrwseyt.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthanF4enl3bGFuam1qcndzZXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NTAzMzUsImV4cCI6MjA4MjMyNjMzNX0.kLtQOJDx2NEYagClt_AwjuoUl1pzXGh6mM7Hg8I9AvA"
  );

/* ===== AUTH + LOAD PROFILE ===== */
async function loadProfile() {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session) {
    location.href = "signin.html";
    return;
  }

  document.getElementById("sidebar-actions").style.display = "flex";

  const user = data.session.user;

  // ✅ Ensure email is stored in profiles (silent + safe)
  await supabaseClient.from("profiles").upsert(
    {
      id: user.id,
      email: user.email
    },
    { onConflict: "id" }
  );

  const { data: profile, error } = await supabaseClient
    .from("profiles")
    .select("name, age, mobile, email, concern")
    .eq("id", user.id)
    .maybeSingle();

  if (!profile) {
    location.href = "profile.html";
    return;
  }
 // ✅ Save email only once (if missing)
  if (!profile.email) {
    await supabaseClient
      .from("profiles")
      .update({ email: user.email })
      .eq("id", user.id);
  }
  // ✅ SHOW DATA (READ-ONLY PAGE)
  document.getElementById("email").value = profile.email || "";
  document.getElementById("full_name").value = profile.name || "";
  document.getElementById("age").value = profile.age || "";
  document.getElementById("mobile").value = profile.mobile || "";
  document.getElementById("concern").value = profile.concern
    ? profile.concern.charAt(0).toUpperCase() + profile.concern.slice(1)
    : "";
}

loadProfile();

/* ================= AUTH CHECK ================= */
async function requireAuth() {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session) {
    location.href = "signin.html";
    return false;
  }
  return true;
}

requireAuth();

/* ===== IDLE TIMEOUT LOGOUT ===== */
let idleTimer;
const IDLE_LIMIT = 10 * 60 * 1000; // 10 minutes

function resetIdleTimer() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(async () => {
    await supabaseClient.auth.signOut();
    window.location.href = "signin.html";
  }, IDLE_LIMIT);
}

["mousemove", "keydown", "click", "scroll", "touchstart"].forEach(evt => {
  document.addEventListener(evt, resetIdleTimer, true);
});

resetIdleTimer();


  /* ===== SIDEBAR ===== */
  const menuIcon = document.getElementById("menu-icon");
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("navbar-overlay");
  let isOpen = false;

  function openSidebar(){
    sidebar.classList.add("active");
    overlay.classList.add("show");
    menuIcon.textContent = "✕";
    isOpen = true;
  }

  function closeSidebar(){
    sidebar.classList.remove("active");
    overlay.classList.remove("show");
    menuIcon.textContent = "☰";
    isOpen = false;
  }

  menuIcon.addEventListener("click", ()=>{
    isOpen ? closeSidebar() : openSidebar();
  });

  overlay.addEventListener("click", closeSidebar);

  document.addEventListener("click",(e)=>{
    if(isOpen && !sidebar.contains(e.target) && !menuIcon.contains(e.target)){
      closeSidebar();
    }
  });

 
  /* ===== SIDEBAR PROFILE / LOGOUT ===== */
  const sidebarActions = document.getElementById("sidebar-actions");
  const sidebarProfile = document.getElementById("sidebar-profile");
  const sidebarLogout = document.getElementById("sidebar-logout");

 
  /* ===== SIDEBAR PROFILE / LOGOUT (SUPABASE) ===== */
async function setupSidebarAuth() {
  const { data } = await supabaseClient.auth.getSession();

  if (data.session) {
    sidebarActions.style.display = "flex";

    sidebarProfile.onclick = () => {
      window.location.href = "user-details.html";
    };

    sidebarLogout.onclick = async () => {
      await supabaseClient.auth.signOut();
      window.location.href = "signin.html";
    };
  }
}

setupSidebarAuth();

</script>

</body>
</html>
